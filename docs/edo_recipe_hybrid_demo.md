# 江戸料理ハイブリッド検索デモ使用ガイド

## 概要

江戸料理ハイブリッド検索デモは、PostgreSQLの**pg_bigm（全文検索）**と**pg_vector（ベクトル検索）**を組み合わせた高度な検索システムです。キーワード検索と意味的検索を統合し、実用的な複合検索機能を提供します。

## 特徴

- 🔍 **4つの検索モード**: 段階的検索、並列検索、全文のみ、ベクトルのみ
- 📋 **複合条件検索**: 必須キーワード + 除外キーワード + 意味的検索
- ⚖️ **スコア合成**: 重み付きハイブリッドスコアリング
- ⚡ **性能測定**: 実行時間、CPU、メモリ使用量の表示
- 📚 **事前定義シナリオ**: 実用的な検索パターン

## 前提条件

### 必要なデータ

1. **江戸料理基本データ**: `edo_recipes`テーブルが存在すること
2. **ベクターデータ**（オプション）: `edo_recipe_vectors`テーブルとOpenAI埋め込みデータ

### 環境確認

```bash
# 基本データの確認
docker exec python_postgres_demo python -c "
import sys; sys.path.append('/app/src')
from common.database_config import DatabaseConfig
from common.edo_recipe_manager import EdoRecipeManager
db_config = DatabaseConfig.from_environment()
manager = EdoRecipeManager(db_config)
print(f'江戸料理テーブル: {\"✅\" if manager.tables_exist() else \"❌\"}')
manager.cur.execute('SELECT COUNT(*) FROM edo_recipes')
print(f'レシピ数: {manager.cur.fetchone()[0]}件')
manager.close()
"
```

## デモの実行

### 基本実行方法

```bash
# Pythonコンテナ内でデモを実行
docker exec -it python_postgres_demo /bin/bash
cd /app
python src/apps/edo_recipe_hybrid_demo.py
```

## 初期セットアップ

初回実行時は以下の手順でデータを準備することを推奨します：

1. **基本データ初期化**: ハイブリッド検索デモの「基本データ初期化」機能で江戸料理レシピデータを作成
2. **ベクターデータの生成**: ハイブリッド検索デモの「ベクター初期化」機能を使用

## 機能紹介

### 1. カスタム検索

自由に検索条件を設定できる柔軟な検索機能です。

#### 設定項目

**必須キーワード設定**
- 含まなければならない言葉を指定
- 複数キーワードはカンマ区切りで入力
- 類似度閾値の調整可能（0.1-1.0）

```
例: だし, 魚
閾値: 0.2 (より厳密なマッチング)
```

**除外キーワード設定**
- 含んではならない言葉を指定
- 複数条件での絞り込みが可能

```
例: 肉, 砂糖, 油
閾値: 0.1 (広範囲の除外)
```

**意味的検索設定**
- 自然言語での検索意図を入力
- OpenAI埋め込みによる意味的類似度検索

```
例: "うま味の効いたあっさりした料理"
```

**スコア重み調整**
- キーワードマッチと意味的類似度の重み比率
- 0.0-1.0の範囲で調整

```
キーワード重視: 0.7 (キーワード) + 0.3 (意味的)
意味的重視:     0.3 (キーワード) + 0.7 (意味的)
```

#### 検索モード

1. **段階的検索（CASCADE）**
   - 高速処理重視
   - pg_bigm → pg_vector の順次実行
   - 大量データに適している

2. **並列検索（PARALLEL）**
   - 高精度重視
   - 同時スコア計算による包括的検索
   - より多くの結果を発見

3. **キーワードのみ（FULLTEXT_ONLY）**
   - pg_bigm全文検索のみ
   - 高速実行
   - 従来の検索手法

4. **意味検索のみ（VECTOR_ONLY）**
   - pg_vectorベクトル検索のみ
   - 意味的関連性重視
   - 発見性の高い検索

### 2. シナリオ検索

実用的な検索パターンを事前定義したデモです。

#### 利用可能シナリオ

**🥚 卵料理専門検索**
```
必須: 卵
除外: 肉 AND 魚
意味: "色鮮やかで美しい卵料理"
重み: キーワード(40%) + 意味的(60%)
モード: 段階的検索
```

**🌈 華やか卵料理検索**
```
必須: 卵
意味: "華やかで彩り豊かな卵料理"
重み: キーワード(60%) + 意味的(40%)
モード: 並列検索
```

**🍲 お吸い物風検索**
```
必須: 卵
意味: "上品でやさしい味の料理"
重み: キーワード(40%) + 意味的(60%)
モード: 段階的検索
```

**🎨 色鮮やか卵検索**
```
必須: 卵
意味: "色とりどりで美しい卵料理"
重み: キーワード(50%) + 意味的(50%)
モード: 並列検索
```

### 3. 性能比較デモ

異なる検索手法の性能を比較測定できます。

### 4. 基本データ初期化

江戸料理レシピの基本データを初期化する機能です。

#### 機能概要
- `edo_recipes` テーブルの作成と基本レシピデータの投入
- `recipe_ingredients` テーブルの作成と材料データの投入  
- `recipe_instructions` テーブルの作成と手順データの投入
- 既存データがある場合はスキップして安全に実行

#### 実行例
```
🔧 基本データ初期化

江戸料理レシピの基本データを初期化します。
この処理では以下のテーブルを作成・データを投入します:
  • edo_recipes (レシピ基本情報)
  • recipe_ingredients (材料情報)
  • recipe_instructions (手順情報)

📊 データベース状態確認中...
  ⚠️  基本テーブルが存在しません。作成します...
  ✅ 基本テーブルを作成しました
  📋 既存レシピ数: 0件

🔄 江戸料理JSONデータを読み込み中...
  ✅ 42件のレシピデータを読み込みました
  ✅ 42件の有効なレシピを検出しました

💾 データベースに挿入中...
  進捗: 5件完了
  進捗: 10件完了
  ...
  進捗: 40件完了

🎉 基本データ初期化が完了しました！
  📊 登録されたレシピ: 42件
  📋 テーブル: edo_recipes, recipe_ingredients, recipe_instructions

💡 次のステップ:
  • ベクター初期化を実行して意味検索を有効化
  • カスタム検索やシナリオ検索をお試しください
```

#### 注意事項
- 既にレシピデータが存在する場合は処理をスキップ
- JSONファイルが見つからない場合はエラーメッセージを表示
- テーブル作成に失敗した場合は処理を中断

### 5. ベクター初期化

全42件の江戸料理レシピの埋め込みベクトルを生成する機能です。

#### 機能概要
- 既存のベクターデータ状況を確認
- 不足分の埋め込みベクトルを自動生成
- OpenAI API使用による高品質な埋め込み作成
- コスト見積もりと確認プロセス

#### 実行例
```
🔧 ベクター初期化

📊 状況確認:
  総レシピ数: 42件
  既存ベクター数: 5件

⚠️  37件のレシピのベクターデータが不足しています。

💰 生成コスト見積もり:
  推定トークン数: 3,700
  推定時間: 18.5秒
  推定コスト: $0.000074 USD
             (約0.011円)

37件のベクターデータを生成しますか？ [y/N]: y

🔄 ベクター生成を開始します...
[ 1/37] 糸組卵                         ✅
[ 2/37] 五色卵                         ✅
...

🎉 全レシピのベクターデータ生成が完了しました！
```

#### 注意事項
- OpenAI APIキーが必要
- 既に全データが存在する場合は処理をスキップ
- 処理中断時は部分的な状態で保存される

### 6. 全データ消去

デモ用データベーステーブルを完全に削除する機能です。

#### 削除対象テーブル
- `edo_recipes` (江戸料理レシピ)
- `edo_recipe_vectors` (ベクターデータ)
- `recipe_similarities` (類似度データ)
- `vector_search_logs` (検索ログ)
- `recipe_ingredients` (レシピ材料)
- `recipe_instructions` (レシピ手順)

#### 安全機能
- 二段階確認プロセス
- 'DELETE' の文字列入力による最終確認
- 取り消し不可の明確な警告

#### 使用場面
- デモ環境のリセット
- 新しいデータセットでのテスト
- ストレージ領域の完全クリア

#### 測定項目

- **実行時間**: SQLクエリ実行からPython結果取得まで
- **CPU使用率**: 検索処理中の平均CPU使用率
- **メモリ使用量**: 検索処理中のピークメモリ使用量
- **マッチ数**: 検索結果件数

#### 比較表示例

```
=== 検索手法性能比較 ===
🔍 段階的検索を実行中...
実行時間: 0.234秒 | CPU使用率: 45% | メモリ使用量: 128MB | マッチ数: 156件

🔍 並列検索を実行中...  
実行時間: 0.187秒 | CPU使用率: 62% | メモリ使用量: 156MB | マッチ数: 203件

🔍 キーワードのみ検索を実行中...
実行時間: 0.089秒 | CPU使用率: 23% | メモリ使用量: 89MB | マッチ数: 89件

🔍 意味検索のみを実行中...
実行時間: 0.334秒 | CPU使用率: 38% | メモリ使用量: 201MB | マッチ数: 234件

┌─────────────┬─────────┬─────────┬─────────┬─────────┐
│検索手法      │実行時間  │CPU使用率│メモリ    │推奨用途 │
├─────────────┼─────────┼─────────┼─────────┼─────────┤
│段階的検索    │0.234秒  │45%      │128MB    │バランス │
│並列検索      │0.187秒  │62%      │156MB    │高精度   │
│キーワードのみ│0.089秒  │23%      │89MB     │高速     │
│意味検索のみ  │0.334秒  │38%      │201MB    │発見性   │
└─────────────┴─────────┴─────────┴─────────┴─────────┘

【推奨】この条件では「並列検索」が最適です
理由: 高精度を維持しつつ高速な実行が可能
```

## 結果表示の見方

### 基本情報

```
=== 検索結果 ===
実行時間: 0.234秒 | 総マッチ数: 156件 | 表示: 10件
CPU使用率: 45% | メモリ使用量: 128MB
```

### 検索処理フロー

```
【検索処理の流れ】
Stage 1 (全文検索): 1,234件 → 156件 (0.089秒)
Stage 2 (ベクトル検索): 156件 → 156件 (0.134秒)
Stage 3 (スコア計算): 156件 → 10件 (0.011秒)
```

### 個別結果詳細

```
🥇 第1位 (総合スコア: 0.89)
【レシピ名】鯛のだし茶漬け
【説明文】上品な鯛の旨みとだしの香りが調和した、あっさりとした一品
【材料】鯛, 昆布だし, 米, 海苔, わさび
【マッチ詳細】
  ✅ 必須キーワード: "だし"(0.94), "魚→鯛"(0.87)
  ❌ 除外キーワード: なし
  🎯 意味的類似度: 0.91 ("うま味があっさり" との類似性)
  📊 スコア内訳: キーワード(0.91) × 0.3 + 意味的(0.91) × 0.7 = 0.89
```

## 実用的な使用例

### 例1: 特定の食材を使った料理検索

```
【シーン】卵を使った料理を探したいが、甘いものは避けたい

設定:
- 必須キーワード: 卵
- 除外キーワード: 砂糖, 甘い
- 意味的検索: "料理の主菜や副菜"
- 検索モード: 段階的検索
```

### 例2: 季節に合った料理の発見

```
【シーン】春らしい彩り豊かな料理を作りたい

設定:
- 必須キーワード: 春, 彩り
- 意味的検索: "季節感のある美しい料理"
- 重み: キーワード(40%) + 意味的(60%)
- 検索モード: 並列検索
```

### 例3: 健康志向の料理探索

```
【シーン】ヘルシーで栄養バランスの良い料理を見つけたい

設定:
- 必須キーワード: 野菜, 健康
- 除外キーワード: 油, 揚げる
- 意味的検索: "栄養価が高くてヘルシーな食事"
- 検索モード: 並列検索
```

## トラブルシューティング

### よくある問題と解決方法

**Q: 検索結果が0件になってしまう**
A: 
- 類似度閾値を下げる（0.1など）
- 必須キーワードを減らす
- 除外条件を緩和する

**Q: ベクトル検索が動作しない**
A:
- ベクターデータが生成されているか確認
- OpenAI API設定を確認
- 全文検索のみモードで代替使用

**Q: 性能が遅い**
A:
- 段階的検索モードを使用
- 結果件数を制限（max_results）
- 必須キーワードで事前絞り込み

### データベース状態確認

```bash
# テーブル存在確認
docker exec python_postgres_demo python -c "
import sys; sys.path.append('/app/src')
from common.database_config import DatabaseConfig
import psycopg2

db_config = DatabaseConfig.from_environment()
conn = psycopg2.connect(**db_config.to_connection_params())
cur = conn.cursor()

# Check tables
tables = ['edo_recipes', 'edo_recipe_vectors']
for table in tables:
    cur.execute(f\"SELECT COUNT(*) FROM information_schema.tables WHERE table_name = '{table}'\")
    exists = cur.fetchone()[0] > 0
    if exists:
        cur.execute(f'SELECT COUNT(*) FROM {table}')
        count = cur.fetchone()[0]
        print(f'{table}: ✅ ({count}件)')
    else:
        print(f'{table}: ❌')

conn.close()
"
```

## 技術仕様

### アーキテクチャ

```
Demo Application (UI)
       ↓
Search Service (Business Logic)
       ↓
Hybrid Manager (Database Operations)
       ↓
PostgreSQL (pg_bigm + pg_vector)
```

### 使用技術

- **PostgreSQL 16**: メインデータベース
- **pg_bigm 1.2**: 日本語全文検索拡張（GIN Index）
- **pg_vector 0.7.4**: ベクター検索拡張（HNSW Index）
- **OpenAI API**: text-embedding-3-small埋め込みモデル
- **Python 3.11**: アプリケーション開発言語
- **psycopg2**: PostgreSQLドライバー
- **psutil**: システム性能測定

### インデックス構造

```sql
-- pg_bigm用GINインデックス（Generalized Inverted Index）
CREATE INDEX idx_edo_recipes_bigm_name ON edo_recipes 
    USING gin (name gin_bigm_ops);

-- pg_vector用HNSWインデックス（Hierarchical Navigable Small World）
CREATE INDEX idx_edo_recipes_embedding ON edo_recipe_vectors 
    USING hnsw (combined_embedding vector_cosine_ops);
```

## 学習ポイント

このデモを通じて以下を学習できます：

1. **pg_bigmとpg_vectorの実用的な組み合わせ方法**
2. **複合検索条件の効率的な実装パターン**
3. **検索精度と実行速度のトレードオフ理解**
4. **透明性の高いスコアリングシステムの実装**
5. **実世界のニーズに対応した検索システム設計**

## 関連ドキュメント

- [ハイブリッド検索システム設計書](./edo_recipe_hybrid_search_design.md)
- [江戸料理検索デモガイド](./edo_recipe_demo.md) - pg_bigm全文検索
- [江戸料理ベクター検索デモガイド](./edo_recipe_vector_demo.md) - pg_vector意味検索